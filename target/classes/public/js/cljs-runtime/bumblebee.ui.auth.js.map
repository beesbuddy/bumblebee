{"version":3,"sources":["bumblebee/ui/auth.cljs"],"mappings":"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","names":["bumblebee.ui.auth/storage-key","js/bumblebee","js/bumblebee.ui","js/bumblebee.ui.auth","js/bumblebee.ui.auth.state","bumblebee.ui.auth/state","cljs.core.atom","bumblebee.ui.auth/now-s","js/Math.floor","js/Date","bumblebee.ui.auth/gen-str","js/Math.random","bumblebee.ui.auth/token-expired?","token","t","or__5025__auto__","cljs.core/deref","cljs.core/not","bumblebee.ui.auth/token-remaining-s","temp__5823__auto__","x__5110__auto__","y__5111__auto__","bumblebee.ui.auth/authed?","and__5023__auto__","bumblebee.ui.auth/persist!","e32531","js/localStorage","cljs.core.pr_str","_","bumblebee.ui.auth/load!","e32540","temp__5825__auto__","s","cljs.reader.read_string","cljs.core.swap_BANG_","cljs.core/assoc","cljs.core/add-watch","bumblebee.ui.auth/clear-timer!","id","js/clearTimeout","bumblebee.ui.auth/schedule-refresh!","remaining","delay-ms","js/setTimeout","bumblebee.ui.auth/refresh-async!","bumblebee.ui.auth/set-token!","bumblebee.ui.auth/set-redirect!","target","bumblebee.ui.auth/take-redirect!","r","bumblebee.ui.auth/logout!","bumblebee.ui.auth/login-async!","js/Promise","resolve","_reject","reject","G__32669","js/Error","t2","cljs.core.assoc","G__32708"],"sourcesContent":["(ns bumblebee.ui.auth\n  (:require\n   [cljs.reader]))\n\n(def storage-key \"uix-starter.jwt\")\n\n(defonce state\n  (atom {:token nil        ;; {:access \"...\" :refresh \"...\" :exp <unix-seconds>}\n         :redirect nil\n         :timer-id nil}))  ;; js/Timeout id for scheduled refresh\n\n(defn now-s []\n  (js/Math.floor (/ (.now js/Date) 1000)))\n\n(defn gen-str []\n  (.toString (js/Math.random) 36))\n\n(defn token-expired? [token]\n  (let [t (or token (:token @state))]\n    (if-not t\n      true\n      (<= (:exp t) (now-s)))))\n\n(defn token-remaining-s []\n  (if-let [t (:token @state)]\n    (max 0 (- (:exp t) (now-s)))\n    0))\n\n(defn authed? []\n  (and (:token @state) (not (token-expired? (:token @state)))))\n\n(defn persist! []\n  (try\n    (.setItem js/localStorage storage-key (pr-str (:token @state)))\n    (catch :default _ nil)))\n\n(defn load! []\n  (try\n    (when-let [s (.getItem js/localStorage storage-key)]\n      (when-let [t (cljs.reader/read-string s)]\n        (swap! state assoc :token t)))\n    (catch :default _ nil)))\n\n(add-watch state ::persist (fn [_ _ _ _] (persist!)))\n\n(declare refresh-async!)\n\n(defn clear-timer! []\n  (when-let [id (:timer-id @state)]\n    (js/clearTimeout id)\n    (swap! state assoc :timer-id nil)))\n\n(defn schedule-refresh! []\n  (clear-timer!)\n  (when-let [t (:token @state)]\n    (let [remaining (- (:exp t) (now-s))\n          delay-ms (* 1000 (max 0 (- remaining 10)))]\n      (when (pos? remaining)\n        (let [id (js/setTimeout (fn [] (refresh-async!)) delay-ms)]\n          (swap! state assoc :timer-id id))))))\n\n(defn set-token! [t]\n  (swap! state assoc :token t)\n  (schedule-refresh!))\n\n(defn set-redirect! [target]\n  (swap! state assoc :redirect target))\n\n(defn take-redirect! []\n  (let [r (:redirect @state)]\n    (swap! state assoc :redirect nil)\n    r))\n\n(defn logout! []\n  (clear-timer!)\n  (swap! state assoc :token nil))\n\n(defn login-async!\n  \"Fake login returning token valid for 60s.\"\n  []\n  (js/Promise.\n    (fn [resolve _reject]\n      (js/setTimeout\n        (fn []\n          (let [t {:access  (str \"acc-\" (gen-str))\n                   :refresh (str \"ref-\" (gen-str))\n                   :exp     (+ (now-s) 60)}]\n            (set-token! t)\n            (resolve t)))\n        800))))\n\n(defn refresh-async!\n  \"Fake refresh using stored refresh token. Extends expiry by 60s.\"\n  []\n  (js/Promise.\n    (fn [resolve reject]\n      (if-let [t (:token @state)]\n        (js/setTimeout\n          (fn []\n            (if (token-expired? t)\n              (do (logout!) (reject (js/Error. \"refresh: token expired\")))\n              (let [t2 (assoc t\n                              :access  (str \"acc-\" (gen-str))\n                              :exp     (+ (now-s) 60))]\n                (set-token! t2)\n                (resolve t2))))\n          500)\n        (reject (js/Error. \"refresh: no token\"))))))\n"]}